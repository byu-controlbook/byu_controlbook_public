# This file tests the f(x,u) function from your dynamics file by comparing its outputs
# against expected outputs for a variety of test cases. It also expects that the inputs
# are forces from the two motors (f_l, f_r) in Newtons. Later we will change that model,
# but we expect to check our dynamics after lab H.3. 

import numpy as np
from case_studies.H_hummingbird.dynamics import HummingbirdDynamics
# x = [phi, theta, psi, phidot, thetadot, psidot]
x_tests = np.array([
    [0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
    [0.1, 0.0, 0.0, 0.0, 0.0, 0.0],
    [0.0, 0.1, 0.0, 0.0, 0.0, 0.0],
    [0.0, 0.0, 0.1, 0.0, 0.0, 0.0],
    [0.0, 0.0, 0.0, 0.1, 0.0, 0.0],
    [0.0, 0.0, 0.0, 0.0, 0.1, 0.0],
    [0.0, 0.0, 0.0, 0.0, 0.0, 0.1],
    [0.1, 0.1, 0.1, 0.0, 0.0, 0.0],
    [0.0, 0.0, 0.0, 0.1, 0.1, 0.1],
    [0.1, 0.1, 0.1, 0.1, 0.1, 0.1],
    [-0.0752759286915825, 0.27042858384594964, 0.13919636508684308, 0.1973169683940732, -0.687962719115127, -0.6880109593275947],
    [-0.2651498326990803, 0.21970568746496105, 0.06066900704592526, 0.416145155592091, -0.9588310114083951, 0.9398197043239886],
    [0.19946558448025303, -0.1725965335930343, -0.19090501967573964, -0.6331909802931324, -0.39151551408092455, 0.04951286326447568],
    [-0.04083298881473052, -0.12526251588117485, 0.0671117368334277, -0.7210122786959163, -0.4157107029295637, -0.2672763134126166],
    [-0.026358009469778454, 0.17110557683580813, -0.18019573070498415, 0.02846887682722321, 0.18482913772408494, -0.9070991745600046],
    [0.06452691114086301, -0.19768552578762508, -0.26096904420883227, 0.8977710745066665, 0.9312640661491187, 0.6167946962329223],
    [-0.1172317384959776, -0.24139673159616967, 0.11053981590729411, -0.1196950125207974, -0.7559235303104423, -0.00964617977745963],
    [-0.27936688733086895, 0.24559224124726925, -0.14473201103998984, 0.32504456870796394, -0.3765778478211781, 0.040136042355621626],
    [0.028026167605967767, -0.18908732668468375, 0.2817507766587351, 0.5502656467222291, 0.8789978831283782, 0.7896547008552977],
    [0.058739987286651085, 0.2531245410138701, -0.2469044987688483, -0.6080342751617096, -0.9095454221789239, -0.3493393384734713],
], dtype=np.float64).reshape(-1, 6, 1)

# u = [f_l, f_r]
u_tests = np.array([
    [0.0, 0.0],
    [0.1, 0.1],
    [0.15, 0.15],
    [0.1, 0.15],
    [0.15, 0.1],
    [0.05, 0.05],
    [0.2, 0.2],
    [0.0, 0.1],
    [0.1, 0.0],
    [0.05, 0.15],
    [0.07773545793789641, 0.05426980635477918],
    [0.1657475018303859, 0.07135066533871785],
    [0.05618690193747616, 0.1085392166316497],
    [0.02818484499495253, 0.16043939615080793],
    [0.014910128735954166, 0.19737738732010346],
    [0.1544489538593315, 0.03974313630683449],
    [0.00110442342472048, 0.16309228569096684],
    [0.14137146876952342, 0.14580143360819747],
    [0.15425406933718916, 0.014808930346818072],
    [0.07169314570885453, 0.023173811905025946],
], dtype=np.float64).reshape(-1, 2)

xdot_tests = np.array([
    [0.0, 0.0, 0.0, 0.0, -6.619452389766421, 0.0],
    [0.0, 0.0, 0.0, 0.0, -1.0067608336709835, 0.5579174050926293],
    [0.0, 0.0, 0.0, 0.0, 1.8753884964453833, 0.0],
    [0.0, 0.0, 0.0, -31.746031746031736, 0.43202360700237374, 0.0],
    [0.1, 0.0, 0.0, 31.216931216931204, 0.43202360700237374, 0.0],
    [0.0, 0.1, 0.0, 0.0, -3.8068073161256852, 0.0],
    [0.0, 0.0, 0.1, 0.0, 4.6629092050636505, -0.00786492064356653],
    [0.0, 0.0, 0.0, -63.46397510763196, -3.780190478856318, 0.2813525307953022],
    [0.1, 0.1, 0.1, 62.97608465608465, -3.8070043601873413, -0.0077626766752001645],
    [0.1, 0.1, 0.1, -63.95299900515524, -0.9826201346803339, 0.5526594632039039],
    [0.1973169683940732, -0.687962719115127, -0.6880109593275947, 14.446210414381897, -2.707317780280758, -0.023586000006884586],
    [0.416145155592091, -0.9588310114083951, 0.9398197043239886, 56.149263996830356, -0.09103040225638326, -2.1715309559204194],
    [-0.6331909802931324, -0.39151551408092455, 0.04951286326447568, -30.080551743506142, -1.9356631045322639, 0.9168702334449086],
    [-0.7210122786959163, -0.4157107029295637, -0.2672763134126166, -79.98273644560479, -1.2154516453450195, -0.22159260709343406],
    [0.02846887682722321, 0.18482913772408494, -0.9070991745600046, -116.24827959479008, -0.6628689290384263, -0.13167727108725752],
    [0.8977710745066665, 0.9312640661491187, 0.6167946962329223, 68.77860451387039, -1.049592995869572, 0.14189231644790898],
    [-0.1196950125207974, -0.7559235303104423, -0.00964617977745963, -102.05457676561613, -1.7684401423667062, -0.5505123099654223],
    [0.32504456870796394, -0.3765778478211781, 0.040136042355621626, -5.090797697068773, 1.3925514960908751, -2.267815839340941],
    [0.5502656467222291, 0.8789978831283782, 0.7896547008552977, 86.54235516956375, -1.7198556398873028, -0.13033724176556788],
    [-0.6080342751617096, -0.9095454221789239, -0.3493393384734713, 34.49771858907354, -3.6928617632654213, 0.3383804271156281],
], dtype=np.float64).reshape(-1, 6, 1)

num_tests = len(x_tests)
num_passed = 0
system = HummingbirdDynamics()
xdot_eqns = np.array(['phid', 'thetad', 'psid', 'phidd', 'thetadd', 'psidd'])
precision = 6

for i, (x, u, xdot_expected) in enumerate(zip(x_tests, u_tests, xdot_tests), start=1):
    xdot_actual = system.f(x, u)
    xdot_expected_flat = xdot_expected.flatten()
    error = xdot_actual - xdot_expected_flat
    correct_indices = np.abs(error) < 1e-12
    if correct_indices.all():
        print(f"Test {i:>2}: PASS")
        num_passed += 1
    else:
        incorrect_indices = np.where(~correct_indices)[0]
        print(f"Test {i:>2}: FAIL - check equations for {xdot_eqns[incorrect_indices]}")
        for idx in incorrect_indices:
            print(f'{xdot_eqns[idx]:>20}: ', end='')
            print(f'yours = {xdot_actual[idx]:<{precision+8}.{precision}g}', end='')
            print(f'expected = {xdot_expected_flat[idx]:.{precision}g}')

if num_passed == num_tests:
    print("\nExcellent work!! The f(x,u) function from your dynamics file has passed all of the tests!\n")
else:
    print(f"\nDarn, {num_passed}/{num_tests} of the tests passed... Keep it up! You'll get it!\n")
